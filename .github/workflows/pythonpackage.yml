name: Python package


jobs:
  publish:
    name: Publish
    needs: build
    on:
      push:
        branches:
          - master

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.6]

    - name: Package
      run: |
        pip install twine
        BUILD=`date +%Y%m%d.%H%M%S` python setup.py bdist_wheel sdist
        twine check dist/*

    - name: Upload to PyPI
      run: |
        twine upload -u __token__ -p ${{ secrets.PYPI_TOKEN }} dist/*

  build:
    on: [push]
    name: Build
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.6]

    steps:
    - name: Checkout code
      uses: actions/checkout@v1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Check formatting
      run: |
        pip install black
        black --check `python setup.py  --name`

    # Dependencies are checked by pylint, so this is as late as we can leave this
    - name: Install dependencies
      run: |
        pip install .

    - name: Lint with pylint
      run: |
        pip install pylint
        pylint --reports=y `python setup.py  --name` tests

    - name: Test with pytest
      run: |
        pip install pytest coverage
        coverage run -m pytest

#    - name: Coverage
#      run: |
#        coverage report --show-missing

    - name: Package
      run: |
        pip install twine
        BUILD=`date +%Y%m%d.%H%M%S` python setup.py bdist_wheel sdist
        twine check dist/*